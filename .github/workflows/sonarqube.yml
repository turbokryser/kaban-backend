name: SonarCloud Analysis
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0  # Полная история для точного анализа
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pylint bandit
        # Если есть requirements.txt
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    - name: Generate coverage report
      run: |
        # Если у вас есть тесты
        python -m pytest tests/ --cov=./ --cov-report=xml --cov-report=html --junitxml=tests-report.xml || echo "No tests found"
    
    - name: Run Pylint
      continue-on-error: true  # Продолжить даже если pylint найдет ошибки
      run: |
        find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" -not -path "./env/*" -not -path "./.env/*" -not -path "*/__pycache__/*" | xargs python -m pylint --exit-zero --output-format=text > pylint-report.txt 2>&1 || true
    
    - name: Run Bandit (security)
      continue-on-error: true
      run: |
        python -m bandit -r . -f txt -o bandit-report.txt -ll || true
    
    - name: SonarCloud Scan
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Автоматически создается GitHub
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}    # Должен быть установлен в secrets репозитория
      with:
        args: >
          -Dsonar.projectKey=turbokryser_kaban-backend
          -Dsonar.organization=turbokryser
          -Dsonar.python.version=3.11
          -Dsonar.sources=.
          -Dsonar.exclusions=**/__pycache__/**,**/*.pyc,venv/**,.venv/**,env/**,.env/**,**/test_*.py,**/*_test.py
          -Dsonar.tests=tests
          -Dsonar.python.coverage.reportPaths=coverage.xml
          -Dsonar.python.pylint.reportPaths=pylint-report.txt
          -Dsonar.python.bandit.reportPaths=bandit-report.txt
          -Dsonar.python.xunit.reportPath=tests-report.xml
